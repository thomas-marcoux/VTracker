<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: trackerFunctions.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: trackerFunctions.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Functions used in the main Tracker pages

window.getCookieByName = function (name) {
    var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    if (match) return match[2];
};

function getCsrfTokenHeader() {
    return {"X-CSRFToken": getCookieByName("csrftoken")};
}

    /** Tracker Sidebar START **/

// Switches visuals between Added/Removed to/from Tracker
function toggleTrackerButton(element) {
    if (element.classList.contains("btn-outline-secondary")) {
        element.classList.remove("btn-outline-secondary");
        element.classList.add("btn-success");
    }
    else if (element.classList.contains("btn-success")) {
        element.classList.remove("btn-success");
        element.classList.add("btn-outline-secondary");
    }
}

// Toggle Content-Tracker relationship
function clickedOnTracker(contentId, trackerId) {
    var trackerButton = document.getElementById(trackerId + "_tracker_button");
    $.ajax({
        type: 'POST',
        url: 'tracker/clickedOnTracker',
        headers: getCsrfTokenHeader(),
        data: {
            trackerId: trackerId,
            contentId: contentId,
            adding: !trackerButton.classList.contains("btn-success"),
        },
        success: function () {
            toggleTrackerButton(trackerButton);
        },
        error: function(error) {
            let error_message = error.responseJSON.message;
            console.log(error_message);
        }
    });
}

//  Add tracker button to the Tracker Sidebar
function createTrackerSidebarButton(trackerId, trackerName, contentId) {
    var newButton = document.createElement("button");
    newButton.classList.add("btn", "mb-1", "w-100", "text-left", "btn-outline-secondary")
    newButton.id = trackerId + "_tracker_button";
    newButton.innerHTML = trackerName;
    newButton.onclick = function(){ clickedOnTracker(contentId, trackerId); };
    return newButton;
}

    /** Tracker Sidebar END **/

//  Add Tracker details button to the Tracker Dashboard
// DEPRECATED - NEED NEW VERSION TO REFLECT LATEST TRACKER DASHBOARD
function createTrackerDashboardButton(trackerId, trackerName) {
    var newLink = document.createElement("a");
    var newButton = document.createElement("button");
    newButton.classList.add("btn", "btn-info", "mb-1", "mr-1");
    newButton.id = trackerId + "_tracker_button";
    newButton.innerHTML = trackerName;
    newLink.href = 'tracker/details/' + trackerId;
    newLink.innerHTML = newButton.outerHTML;
    return newLink;
}

// Send request to add Tracker to DB and add button to the HTML Tracker list
function addTracker(contentId = null) {
    var trackerName = document.getElementById("createTrackerInput").value;
    var errorElement = document.getElementById("trackerErrorMessage");
    var list = document.getElementById("trackerList");
    $.ajax({
        type: 'POST',
        url: 'tracker/addTracker',
        headers: getCsrfTokenHeader(),
        data: {
            trackerName: trackerName,
        },
        success: function (data) {
            if (!data.error) {
                var newListItem = document.createElement("li");
                newListItem.classList.add("d-inline");
                list.insertBefore(newListItem, list.childNodes[0]);
                // If the tracker is being added from the sidebar
                if (contentId) {
                    newListItem.appendChild(createTrackerSidebarButton(data.trackerId, trackerName, contentId));
                    clickedOnTracker(contentId, data.trackerId);
                }
                else {
                    newListItem.appendChild(createTrackerDashboardButton(data.trackerId, trackerName));
                }
                errorElement.style.display = "none"
            }
            else {
                errorElement.innerHTML = data.message;
                errorElement.style.display = "inline"
            }
        }
    });
}

class TrackMenu {

    constructor(cards = null) {

        this.trackMenuDummy = document.querySelector("div#trackMenu.dummy");
        this.cards = cards;
        this.initialize();

    }

    initialize() {

    }

    clone(type) {

        this.trackMenuCopy = this.trackMenuDummy.cloneNode(true);
        this.trackMenuCopy.classList.remove("dummy");
        this.show();
        
        this.trackMenuCopy.classList.add(type);

        this.trackersWindow = this.trackMenuCopy.querySelector('div#menu ul#trackers');
        this.createTrackerForm = this.trackMenuCopy.querySelector("form#createTrackerForm");
        this.addTrackerButton = this.trackMenuCopy.querySelector("form#createTrackerForm button#addTracker");
        this.createTrackerButton = this.trackMenuCopy.querySelector("form#createTrackerForm button#createTracker");
        this.trackerName = this.createTrackerForm.querySelector('input#trackerName')
        this.trackerDesc = this.createTrackerForm.querySelector('textarea#trackerDescription')
        this.searchBox = this.trackMenuCopy.querySelector("input#searchBox");
        this.trackMenuCopy.addEventListener("touchend", this.menuClickListener);
        this.trackMenuCopy.addEventListener("click", this.menuClickListener);
        this.searchBox.addEventListener("keyup", this.searchBoxKeyUpListener.bind(this));
    }

    searchBoxKeyUpListener() {            
        let trackers = event.target.parentElement.querySelector("ul#trackers").getElementsByTagName('li');
        let searchValue = event.target.value;
        //Dynamic Search List
        if(searchValue.length == 0 ){ //Reset list
            for(var i=0; i &lt; trackers.length; i++){
                trackers[i].style.display = 'block';}
        }
        for(var i=0; i &lt; trackers.length; i++){//Reset list after backspacing
            if((trackers[i].getElementsByTagName('span')[0].innerHTML).toUpperCase().includes(searchValue.toUpperCase())){
                trackers[i].style.display = 'block';
            }
            else if(!(trackers[i].getElementsByTagName('span')[0].innerHTML).toUpperCase().includes(searchValue.toUpperCase())){//Hide unmatched search results
                trackers[i].style.display = 'none';
            }
        }
    }

    // Check tracker Ids for existing tracker relationships
    queryTrackerRelationship(trackerIds, contentId) {
        return new Promise((resolve, reject) => {
            $.ajax({
                type: 'POST',
                dataType: 'json',
                url: '/tracker/queryTrackerRelationship',
                headers: getCsrfTokenHeader(),
                data: {
                    trackerIds: trackerIds,
                    contentId: contentId,
                },
                success: function (data) {
                    resolve(data);
                },
                error: function(error) {
                    reject(error);
                }
            });
        });
    }

    setupTrackers(type, contentId) {

        this.trackers = this.trackMenuCopy.querySelectorAll("div#menu ul#trackers li");

        let trackerIds = [];
        for (let i = 0; i &lt; this.trackers.length; i++) {
            this.trackers[i].addEventListener("click", this.trackersClickListener.bind(this));
            trackerIds.push(this.trackers[i].getAttribute("trackerId"));
        }

        if (type == "footer") {
            return;
        }
        
        this.contentId = contentId;
        this.queryTrackerRelationship(trackerIds, contentId)
        .then(data => {
            if (data.trackerRelationships) {
                let relationships = data.trackerRelationships;
                for (let i = 0; i &lt; this.trackers.length; i++) {
                    let button = this.trackers[i].querySelector('button#checkMark');
                    let trackerId = this.trackers[i].getAttribute("trackerId");
                    if (relationships[trackerId] == true) {
                        button.classList.add('selected');
                    }
                    else {
                        button.classList.remove('selected');
                    }
                }
            }
        })
        .catch(error => {
            console.log(error);
        });
    }

    trackersClickListener() {
        
        let button = event.target.parentElement.querySelector("button#checkMark");
        let adding = !button.classList.contains('selected');
        let trackerId = button.parentElement.getAttribute("trackerId");
        let contentIds = [];

        // Card - Single selection
        if (this.trackMenuCopy.classList.contains('card')) {
            contentIds.push(this.contentId);
        }
        // Footer - Multi-selection
        else if (this.trackMenuCopy.classList.contains('footer')) {
            let selectedThumbnails = document.querySelectorAll('main#content ul#cards li#card div#thumbnail.selected');

            for (let i = 0; i &lt; selectedThumbnails.length; i++) {
                contentIds.push(selectedThumbnails[i].parentElement.getAttribute("contentId"));
            }
        }
        else {
            console.log('Incorrect type');
            return;
        }

        trackersClickHandler(trackerId, contentIds, adding).then(data => {
            button.classList.toggle("selected");
            if (this.cards) {
                this.cards.updateTrackingButtons();
            }
        })
        .catch(error => {
            let error_message = error.responseJSON.message;
            console.log(error_message);
        })
    }

    setupCreateTracker() {

        this.addTrackerButton.addEventListener("click", this.addTrackerClickListener.bind(this));
        this.createTrackerButton.addEventListener("click", this.createTrackerClickHandler.bind(this));

    }

    addTrackerClickListener(event) {

        event.preventDefault();
        this.createTrackerForm.classList.toggle("creating");
        // Reset field values in case of previous tracker creation
        this.createTrackerForm.querySelector('input#trackerName').value = '';
        this.createTrackerForm.querySelector('textarea#trackerDescription').value = '';
    }

    createTrackerClickHandler(event) {
        event.preventDefault();
        this.createTrackerAction();
    }

    createTrackerAction() {
        let trackerName = this.trackerName.value.trim();
        let trackerDesc = this.trackerDesc.value;
        let trackerListDummy = this.trackMenuDummy.querySelector('div#menu ul#trackers');
        let trackerListCopy = this.trackersWindow;

        if(trackerName.length != 0){//Empty field for tracker name
            createTracker(trackerName, trackerDesc).then(data => {
                if (!data.error) {
                        let newListItem = document.createElement("li");
                        newListItem.setAttribute("trackerId", data.trackerId);
                        newListItem.innerHTML = '&lt;span>' + trackerName.substring(0,15) + '&lt;/span>&lt;button id="checkMark">&lt;/button>';
                        trackerListDummy.insertBefore(newListItem.cloneNode(true), trackerListDummy.childNodes[0]);
                        trackerListCopy.insertBefore(newListItem, trackerListCopy.childNodes[0]);
                        newListItem.addEventListener('click', this.trackersClickListener.bind(this));
                        if (document.querySelector('p#errorMessage') != undefined) {
                            $('p#errorMessage').remove()
                            $('div#createTrackerFormWrapper input#trackerName').css({"border-color":""})
                        }
                    }
                else {
                    if (document.querySelector('p#errorMessage') == undefined){
                        $('div#createTrackerFormWrapper').append("&lt;p id='errorMessage' style='color:red;'>There is another tracker with the same name.&lt;/p>")
                        $('div#createTrackerFormWrapper input#trackerName').css({"border-color": "red"})
                    }
                    console.log(data.message);

                }
                }).catch(error => {
                    console.log(error);
                });
                createTrackerForm.classList.toggle('creating');
            }
        }           
        

    show() {

        this.trackMenuCopy.classList.remove("hidden");

    }

    hide() {

        this.trackMenuCopy.classList.add("hidden");

    }

    create(type, content=null) {

        this.clone(type);
        this.setupTrackers(type, content);
        this.setupCreateTracker();

    }

    menuClickListener(event) {
        if (document.querySelector('p#errorMessage') != undefined) {
            $('p#errorMessage').remove()
            $('div#createTrackerFormWrapper input#trackerName').css({"border-color":""})
        }
        event.stopPropagation(); // https://stackoverflow.com/questions/152975/how-do-i-detect-a-click-outside-an-element

    }

}

function trackersClickHandler(trackerId, contentIds, adding) {
    return new Promise((resolve, reject) => {
            $.ajax({
                type: 'POST',
                url: 'tracker/clickedOnTracker',
                dataType: 'json',
                headers: getCsrfTokenHeader(),
                data: {
                    trackerId: trackerId,
                    contentIds: contentIds,
                    adding: adding,
                },
                success: function(data) {
                    resolve(data);
                },
                error: function(error) {
                    reject(error);
                }
            });
        });
}

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BarChart.html">BarChart</a></li><li><a href="BaseAnalytics.html">BaseAnalytics</a></li><li><a href="BaseChart.html">BaseChart</a></li><li><a href="channelObserver.ChannelObserver.html">channelObserver.ChannelObserver</a></li><li><a href="contentAnalysis.Categories.html">contentAnalysis.Categories</a></li><li><a href="contentAnalysis.ContentAnalysis.html">contentAnalysis.ContentAnalysis</a></li><li><a href="contentAnalysis.Emotions.html">contentAnalysis.Emotions</a></li><li><a href="contentAnalysis.Keywords.html">contentAnalysis.Keywords</a></li><li><a href="contentAnalysis.Language.html">contentAnalysis.Language</a></li><li><a href="contentAnalysis.Opinions.html">contentAnalysis.Opinions</a></li><li><a href="contentAnalysis.SharedChart.html">contentAnalysis.SharedChart</a></li><li><a href="contentAnalysis.VideoComments.html">contentAnalysis.VideoComments</a></li><li><a href="contentAnalysis.VideoDetails.html">contentAnalysis.VideoDetails</a></li><li><a href="contentEngagement.CommentStats.html">contentEngagement.CommentStats</a></li><li><a href="contentEngagement.ContentEngagement.html">contentEngagement.ContentEngagement</a></li><li><a href="contentEngagement.Dislikes.html">contentEngagement.Dislikes</a></li><li><a href="contentEngagement.Likes.html">contentEngagement.Likes</a></li><li><a href="contentEngagement.Suscribers.html">contentEngagement.Suscribers</a></li><li><a href="contentEngagement.VideoDetails.html">contentEngagement.VideoDetails</a></li><li><a href="contentEngagement.VideoPlayerTable.html">contentEngagement.VideoPlayerTable</a></li><li><a href="contentEngagement.Views.html">contentEngagement.Views</a></li><li><a href="dashboardAnalytics.DailyVideoViews.html">dashboardAnalytics.DailyVideoViews</a></li><li><a href="dashboardAnalytics.Dashboard.html">dashboardAnalytics.Dashboard</a></li><li><a href="dashboardAnalytics.PostingFrequency.html">dashboardAnalytics.PostingFrequency</a></li><li><a href="dashboardAnalytics.RelatedVideos.html">dashboardAnalytics.RelatedVideos</a></li><li><a href="dashboardAnalytics.SocialMediaFootprint.html">dashboardAnalytics.SocialMediaFootprint</a></li><li><a href="dashboardAnalytics.StatisticsRibbon.html">dashboardAnalytics.StatisticsRibbon</a></li><li><a href="dashboardAnalytics.TopKeywords.html">dashboardAnalytics.TopKeywords</a></li><li><a href="DataTable.html">DataTable</a></li><li><a href="DataTableVideoComments.html">DataTableVideoComments</a></li><li><a href="DataTableVideoPlayer.html">DataTableVideoPlayer</a></li><li><a href="DatePicker.html">DatePicker</a></li><li><a href="LineChart.html">LineChart</a></li><li><a href="NetworkAnalysis.html">NetworkAnalysis</a></li><li><a href="NetworkAnalysis.RelatedVideosGraph.html">NetworkAnalysis.RelatedVideosGraph</a></li><li><a href="NetworkGraph.html">NetworkGraph</a></li><li><a href="PieChart.html">PieChart</a></li><li><a href="postingFrequency.Categories.html">postingFrequency.Categories</a></li><li><a href="postingFrequency.ChannelDetails.html">postingFrequency.ChannelDetails</a></li><li><a href="postingFrequency.ChannelLocation.html">postingFrequency.ChannelLocation</a></li><li><a href="postingFrequency.ChannelMap.html">postingFrequency.ChannelMap</a></li><li><a href="postingFrequency.PostingFrequency.html">postingFrequency.PostingFrequency</a></li><li><a href="postingFrequency.PostingFrequencyChart.html">postingFrequency.PostingFrequencyChart</a></li><li><a href="postingFrequency.StatisticsRibbon.html">postingFrequency.StatisticsRibbon</a></li><li><a href="postingFrequency.SubCategories.html">postingFrequency.SubCategories</a></li><li><a href="sentimentAnalysis.SentimentAnalysis.html">sentimentAnalysis.SentimentAnalysis</a></li><li><a href="TreeMap.html">TreeMap</a></li><li><a href="WorldMap.html">WorldMap</a></li></ul><h3>Global</h3><ul><li><a href="global.html#abbreviateNumber">abbreviateNumber</a></li><li><a href="global.html#CHART_COLOR">CHART_COLOR</a></li><li><a href="global.html#createTrackerDashboardButton">createTrackerDashboardButton</a></li><li><a href="global.html#fetchData">fetchData</a></li><li><a href="global.html#FIGURE_HEIGHT">FIGURE_HEIGHT</a></li><li><a href="global.html#Implementlogicwhenachannelisclicked">Implement logic when a channel is clicked</a></li><li><a href="global.html#insertRender">insertRender</a></li><li><a href="global.html#TEXT_COLOR">TEXT_COLOR</a></li><li><a href="global.html#toggleTrackerButton">toggleTrackerButton</a></li><li><a href="global.html#updateRender">updateRender</a></li><li><a href="global.html#updateSideButton">updateSideButton</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
