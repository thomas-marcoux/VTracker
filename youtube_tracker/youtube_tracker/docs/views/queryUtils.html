<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>queryUtils.py</title>
  <link rel="stylesheet" href="..\pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>queryUtils.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>Utilities shared between views and used to query the database or Elastic Search.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>General imports</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.template.defaulttags</span> <span class="kn">import</span> <span class="n">widthratio</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">render_to_string</span>
<span class="kn">from</span> <span class="nn">plum</span> <span class="kn">import</span> <span class="n">dispatch</span>
<span class="kn">import</span> <span class="nn">logging</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Django imports</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">django.forms.models</span> <span class="kn">import</span> <span class="n">model_to_dict</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Elastic Search imports</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">Elasticsearch</span>
<span class="kn">from</span> <span class="nn">elasticsearch_dsl</span> <span class="kn">import</span> <span class="n">Search</span><span class="p">,</span> <span class="n">Q</span> <span class="k">as</span> <span class="n">ES_Q</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Sub packages</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">Channels</span><span class="p">,</span> <span class="n">TrackerRelationship</span><span class="p">,</span> <span class="n">Tracker</span><span class="p">,</span> <span class="n">Videos</span><span class="p">,</span> <span class="n">RelatedVideos</span>
<span class="kn">from</span> <span class="nn">.genericUtilities</span> <span class="kn">import</span> <span class="n">convertToDate</span><span class="p">,</span> <span class="n">elasticSearchResponseToInteger</span><span class="p">,</span> <span class="n">dictionaryMerge</span>
<span class="kn">from</span> <span class="nn">.genericUtilities</span> <span class="kn">import</span> <span class="n">elasticSearchResponseToInteger</span><span class="p">,</span> <span class="n">convertToDate</span><span class="p">,</span> <span class="n">parseRequest</span>
<span class="kn">from</span> <span class="nn">.genericUtilities</span> <span class="kn">import</span> <span class="n">elasticSearchResponseToInteger</span><span class="p">,</span> <span class="n">convertToDate</span><span class="p">,</span> <span class="n">parseRequest</span>
<span class="kn">from</span> <span class="nn">.youtubeUtils</span> <span class="kn">import</span> <span class="n">contentIsVideo</span>
<span class="kn">from</span> <span class="nn">.wrappers</span> <span class="kn">import</span> <span class="n">ajax_post_required</span><span class="p">,</span> <span class="n">ajax_get_required</span>

<span class="n">es_index</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ELASTICSEARCH_INDICES</span><span class="p">[</span><span class="s1">&#39;es_indices&#39;</span><span class="p">]</span>
<span class="n">es_client</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">([</span><span class="n">es_index</span><span class="p">[</span><span class="s1">&#39;es-cluster-host&#39;</span><span class="p">]],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <h2>Channel Queries</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Return channels objects. Ids accepts a single tracker id or a list of channel ids. Returns in (optional) given order parameters.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getChannels</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s1">&#39;joined_date&#39;</span><span class="p">,</span> <span class="n">order_desc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;channel_id&#39;</span><span class="p">,</span> <span class="s1">&#39;channel_title&#39;</span><span class="p">,</span> <span class="s1">&#39;joined_date&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">]</span>
    <span class="n">channels_qs</span> <span class="o">=</span> <span class="n">getChannelQuerySet</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">)</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">channels_qs</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">as_dict</span><span class="p">:</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">{</span><span class="n">channel</span><span class="p">[</span><span class="s1">&#39;channel_id&#39;</span><span class="p">]:</span> <span class="n">channel</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">channels</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Return channels belonging to given tracker in (optional) given order parameters.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getChannelIDs</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s1">&#39;joined_date&#39;</span><span class="p">,</span> <span class="n">order_desc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">sort_by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tracker_content</span> <span class="o">=</span> <span class="n">getTrackerRelationshipObjects</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">,</span> <span class="s1">&#39;channel&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">tracker_content</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;content_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">channels_qs</span> <span class="o">=</span> <span class="n">getChannelQuerySet</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">channels_qs</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;channel_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Return IDs of videos published by given channel IDs.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getChannelsVideos</span><span class="p">(</span><span class="n">channel_ids</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">videos_qs</span> <span class="o">=</span> <span class="n">getVideoQuerySet</span><span class="p">([],</span> <span class="n">channel_ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">videos_qs</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;video_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Return QuerySet of Channels belonging to given tracker in (optional) given order parameters.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@dispatch</span>
<span class="k">def</span> <span class="nf">getChannelQuerySet</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">getChannelQuerySet</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">),</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Return QuerySet of Channels belonging to given tracker in (optional) given order parameters.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@dispatch</span>
<span class="k">def</span> <span class="nf">getChannelQuerySet</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">query_set</span> <span class="o">=</span> <span class="n">getTrackerRelationshipObjects</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">,</span> <span class="s1">&#39;channel&#39;</span><span class="p">)</span>
    <span class="n">channel_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query_set</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;content_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">getChannelQuerySet</span><span class="p">(</span><span class="n">channel_ids</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Return QuerySet of Channels matching given IDs in (optional) given order parameters.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@dispatch</span>
<span class="k">def</span> <span class="nf">getChannelQuerySet</span><span class="p">(</span><span class="n">channel_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">query_set</span> <span class="o">=</span> <span class="n">Channels</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">channel_id__in</span><span class="o">=</span><span class="n">channel_ids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sort_by</span><span class="p">:</span>
        <span class="n">query_set</span> <span class="o">=</span> <span class="n">query_set</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;{&#39;-&#39; if order_desc else &#39;&#39;}</span><span class="si">{sort_by}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">query_set</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <h2>Video Queries</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Return Videos objects. Accepts a list of video IDs or a parent tracker (which will include videos from tracked channels). (Optional) Sorted by publication date and order parameters unless set to None or otherwise specified.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getVideos</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s1">&#39;published_date&#39;</span><span class="p">,</span> <span class="n">order_desc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;video_id&#39;</span><span class="p">,</span> <span class="s1">&#39;video_title&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;published_date&#39;</span><span class="p">]</span>
    <span class="n">videos_qs</span> <span class="o">=</span> <span class="n">getVideoQuerySet</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
    <span class="n">videos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">videos_qs</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">as_dict</span><span class="p">:</span>
        <span class="n">videos</span> <span class="o">=</span> <span class="p">{</span><span class="n">video</span><span class="p">[</span><span class="s1">&#39;video_id&#39;</span><span class="p">]:</span> <span class="n">video</span> <span class="k">for</span> <span class="n">video</span> <span class="ow">in</span> <span class="n">videos</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">videos</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>Return only videos IDs added to tracker, excluding videos from tracked channels.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getVideoIDs</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">tracker_content</span> <span class="o">=</span> <span class="n">getTrackerRelationshipObjects</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">tracker_content</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;video&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;content_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Return video IDs belonging to given tracker, including videos from tracked channels. (Optional) Sorted by publication date unless set to None or otherwise specified. Return results between date bracket if provided.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getTrackerVideoIDs</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s2">&quot;published_date&quot;</span><span class="p">,</span> <span class="n">order_desc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">videos_qs</span> <span class="o">=</span> <span class="n">getVideoQuerySet</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">videos_qs</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;video_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Return QuerySet of Videos belonging to given tracker. Return results between date bracket in given order parameters if provided.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@dispatch</span>
<span class="k">def</span> <span class="nf">getVideoQuerySet</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">end_date</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">getVideoQuerySet</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">),</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Return QuerySet of Videos belonging to given tracker. Return results between date bracket in given order parameters if provided.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@dispatch</span>
<span class="k">def</span> <span class="nf">getVideoQuerySet</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">end_date</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">tracker_content</span> <span class="o">=</span> <span class="n">getTrackerRelationshipObjects</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">)</span>
    <span class="n">video_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tracker_content</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;video&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;content_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">())</span>
    <span class="n">channel_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tracker_content</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;channel&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;content_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">getVideoQuerySet</span><span class="p">(</span><span class="n">video_ids</span><span class="p">,</span> <span class="n">channel_ids</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>Return QuerySet of Videos for given video IDs. Return results between date bracket in given order parameters if provided.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@dispatch</span>
<span class="k">def</span> <span class="nf">getVideoQuerySet</span><span class="p">(</span><span class="n">video_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">end_date</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">getVideoQuerySet</span><span class="p">(</span><span class="n">video_ids</span><span class="p">,</span> <span class="p">[],</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>Return QuerySet of Videos belonging to given tracker, including videos published by tracked channels. Return results between date bracket in given order parameters if provided.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@dispatch</span>
<span class="k">def</span> <span class="nf">getVideoQuerySet</span><span class="p">(</span><span class="n">video_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">channel_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order_desc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">start_date</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">query_set</span> <span class="o">=</span> <span class="n">Videos</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">video_id__in</span><span class="o">=</span><span class="n">video_ids</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">channel_id__in</span><span class="o">=</span><span class="n">channel_ids</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">start_date</span> <span class="ow">and</span> <span class="n">end_date</span><span class="p">:</span>
        <span class="n">query_set</span> <span class="o">=</span> <span class="n">query_set</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">published_date__range</span><span class="o">=</span><span class="p">[</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">sort_by</span><span class="p">:</span>
        <span class="n">query_set</span> <span class="o">=</span> <span class="n">query_set</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;{&#39;-&#39; if order_desc else &#39;&#39;}</span><span class="si">{sort_by}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">query_set</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <h2>Tracker Queries</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>Returns a tracker_data object to populate the target. If with_date_range is True, return the start end date of the content.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getTrackerDetails</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">tracker_id</span><span class="p">,</span> <span class="n">with_date_range</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">public</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;public&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;public&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="n">tracker_object</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Tracker</span><span class="p">,</span> <span class="n">tracker_id</span><span class="o">=</span><span class="n">tracker_id</span><span class="p">,</span> <span class="n">tracker_creater</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> \
        <span class="k">if</span> <span class="ow">not</span> <span class="n">public</span> <span class="k">else</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Tracker</span><span class="p">,</span> <span class="n">tracker_id</span><span class="o">=</span><span class="n">tracker_id</span><span class="p">,</span> <span class="n">is_public</span><span class="o">=</span><span class="n">public</span><span class="p">)</span>
    <span class="n">tracker_data</span> <span class="o">=</span> <span class="n">model_to_dict</span><span class="p">(</span><span class="n">tracker_object</span><span class="p">)</span>
    <span class="n">tracker_data</span><span class="p">[</span><span class="s1">&#39;contentType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;tracker&#39;</span>
    <span class="n">tracker_data</span><span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracker_object</span><span class="o">.</span><span class="n">created_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%b </span><span class="si">%d</span><span class="s2"> %Y | %I:%M %p&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">with_date_range</span><span class="p">:</span>
        <span class="n">setTrackerDateRange</span><span class="p">(</span><span class="n">tracker_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tracker_data</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>Return QuerySet for a given tracker&rsquo;s content (channel or video). Specify content_id to check if the relationship exists.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getTrackerRelationshipObjects</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">queryset</span> <span class="o">=</span> <span class="n">TrackerRelationship</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tracker</span><span class="o">=</span><span class="n">tracker_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">content_type</span><span class="p">:</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">content_id</span><span class="p">:</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">content_id</span><span class="o">=</span><span class="n">content_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">queryset</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>Return the user&rsquo;s trackers with a parameter indicated whether the content is in them. Used to display trackers in modals.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getTrackersWithRelationship</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">content_id</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">trackers</span> <span class="o">=</span> <span class="n">Tracker</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tracker_creater</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;tracker_id&#39;</span><span class="p">,</span> <span class="s1">&#39;tracker_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_time&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="n">trackers</span><span class="p">:</span>
        <span class="n">relationship_qs</span> <span class="o">=</span> <span class="n">getTrackerRelationshipObjects</span><span class="p">(</span><span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;tracker_id&#39;</span><span class="p">],</span> <span class="n">content_id</span><span class="o">=</span><span class="n">content_id</span><span class="p">)</span>
        <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;contentIsInTracker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship_qs</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">trackers</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>Appends date range data to the given tracker object. The start is the oldest found publication date and the end is the most recent publication date.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">setTrackerDateRange</span><span class="p">(</span><span class="n">tracker_data</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;video&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">date_field</span> <span class="o">=</span> <span class="s1">&#39;joined_date&#39;</span> <span class="k">if</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s1">&#39;channel&#39;</span> <span class="k">else</span> <span class="s1">&#39;published_date&#39;</span>
    <span class="n">oldest_entry</span><span class="p">,</span> <span class="n">latest_entry</span> <span class="o">=</span> <span class="n">getTrackerDateRange</span><span class="p">(</span><span class="n">tracker_data</span><span class="p">[</span><span class="s1">&#39;tracker_id&#39;</span><span class="p">],</span> <span class="n">date_field</span><span class="p">)</span>
    <span class="n">tracker_data</span><span class="p">[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latest_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">date_field</span><span class="p">]</span>
    <span class="n">tracker_data</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldest_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">date_field</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>Get the tracker&rsquo;s date range from oldest to most recent. Queries either videos or channels.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getTrackerDateRange</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">,</span> <span class="n">date_field</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">query_set</span> <span class="o">=</span> <span class="n">getChannelQuerySet</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">date_field</span> <span class="o">==</span> <span class="s1">&#39;joined_date&#39;</span> <span class="k">else</span> <span class="n">getVideoQuerySet</span><span class="p">(</span><span class="n">tracker_id</span><span class="p">)</span>
    <span class="n">oldest_entry</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query_set</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">date_field</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">date_field</span><span class="p">))</span>
    <span class="n">latest_entry</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query_set</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">date_field</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">date_field</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">oldest_entry</span><span class="p">,</span> <span class="n">latest_entry</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>Return number of trackers tracking given content. For the user, and across all users.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getTrackingNumbers</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">content_ids</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">total_tracking</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">global_tracking</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">contentId</span> <span class="ow">in</span> <span class="n">content_ids</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">TrackerRelationship</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">content_id</span><span class="o">=</span><span class="n">contentId</span><span class="p">)</span>
        <span class="n">total_tracking</span><span class="p">[</span><span class="n">contentId</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">global_tracking</span><span class="p">[</span><span class="n">contentId</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">global_tracking</span><span class="p">[</span><span class="n">contentId</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_tracking</span><span class="p">[</span><span class="n">contentId</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">relationship</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">tracker_creater</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
                <span class="n">total_tracking</span><span class="p">[</span><span class="n">contentId</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_tracking</span><span class="p">[</span><span class="n">contentId</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">total_tracking</span><span class="p">,</span> <span class="n">global_tracking</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>Elastic Search &amp; Aggregations</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>Call getDateRangeContentRequest for videos. Set id_field to channel_id and provide channel IDs to find videos published by the channels.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getDateRangeVideoRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">id_field</span><span class="o">=</span><span class="s1">&#39;video_id&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">getDateRangeContentRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">id_field</span><span class="p">,</span> <span class="s1">&#39;es-videos&#39;</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="s1">&#39;published_date&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>Call getLatestDailyRequest for videos.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getLatestDailyVideosRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_field</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">getLatestDailyRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="s1">&#39;video_id&#39;</span><span class="p">,</span> <span class="s1">&#39;es-videos_daily&#39;</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">sort_field</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>Call getLatestDailyRequest for channels.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getLatestDailyChannelsRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_field</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">getLatestDailyRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="s1">&#39;channel_id&#39;</span><span class="p">,</span> <span class="s1">&#39;es-channels_daily&#39;</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">sort_field</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>Call getDateRangeContentRequest for videos.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getDateRangeDailyVideoRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">getDateRangeContentRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="s1">&#39;video_id&#39;</span><span class="p">,</span> <span class="s1">&#39;es-videos_daily&#39;</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>Call getDateRangeContentRequest for given video or parent comment. If exclude_replies is True, only the parent comments are queried.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@dispatch</span>
<span class="k">def</span> <span class="nf">getDateRangeCommentsRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">exclude_replies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">getDateRangeCommentsRequest</span><span class="p">([</span><span class="n">ids</span><span class="p">],</span> <span class="n">fields</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">exclude_replies</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>Call getDateRangeContentRequest for given video(s) or parent comment(s). If exclude_replies is True, only the parent comments are queried.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@dispatch</span>
<span class="k">def</span> <span class="nf">getDateRangeCommentsRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">exclude_replies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">keyword_id</span> <span class="o">=</span> <span class="s1">&#39;reply_to&#39;</span>
    <span class="k">if</span> <span class="n">contentIsVideo</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">keyword_id</span> <span class="o">=</span> <span class="s1">&#39;video_id&#39;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">getDateRangeContentRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">keyword_id</span><span class="p">,</span> <span class="s1">&#39;es-comments&#39;</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span>
                                          <span class="s1">&#39;published_date&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s1">&#39;reply_to&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">exclude_replies</span> <span class="k">else</span> <span class="n">response</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>Return ElasticSearch request for entries within given date range for given IDs (or all entries if unspecified). Used for histogram views to show periodical engagement.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getDateRangeContentRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">id_field</span><span class="p">,</span> <span class="n">es_index_name</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;extracted_date&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">search</span> <span class="o">=</span> <span class="n">Search</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">es_index</span><span class="p">[</span><span class="n">es_index_name</span><span class="p">],</span> <span class="n">using</span><span class="o">=</span><span class="n">es_client</span><span class="p">)</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ES_Q</span><span class="p">({</span><span class="s1">&#39;terms&#39;</span><span class="p">:</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{id_field}</span><span class="s1">.keyword&#39;</span><span class="p">:</span> <span class="n">ids</span><span class="p">}}))</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">start_date</span> <span class="ow">and</span> <span class="n">end_date</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ES_Q</span><span class="p">({</span><span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">date_field</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;gte&#39;</span><span class="p">:</span> <span class="n">start_date</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">:</span> <span class="n">end_date</span><span class="p">}}}))</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">date_field</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">search</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>Build a list of data given the ElasticSearch QuerySet. Return response to pass to frontend as data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">buildElasticSearchResponse</span><span class="p">(</span><span class="n">result</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tableData</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;hits&#39;</span><span class="p">][</span><span class="s1">&#39;hits&#39;</span><span class="p">]</span>
    <span class="n">published_date_format</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
        <span class="n">dateFormat</span> <span class="o">=</span> <span class="n">convertToDate</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;_source&#39;</span><span class="p">][</span><span class="s1">&#39;published_date&#39;</span><span class="p">],</span> <span class="n">published_date_format</span><span class="p">)</span>
        <span class="n">dateStr</span> <span class="o">=</span> <span class="n">dateFormat</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%b </span><span class="si">%d</span><span class="s2"> %Y (%H:%M)&quot;</span><span class="p">)</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_source&#39;</span><span class="p">][</span><span class="s1">&#39;published_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dateStr</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;_source&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">tableDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tableDict</span><span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">title</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">tableData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tableDict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tableData</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>Return a map of the Related Videos Table. Including the number of videos each video is related to.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getRelatedVideos</span><span class="p">(</span><span class="n">video_ids</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;video_id&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_video&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;thumbnails_medium_url&#39;</span><span class="p">,</span> <span class="s1">&#39;published_date&#39;</span><span class="p">]</span>
    <span class="n">id_field</span> <span class="o">=</span> <span class="s1">&#39;parent_video&#39;</span>
    <span class="n">related_videos_search</span> <span class="o">=</span> <span class="n">getDateRangeContentRequest</span><span class="p">(</span><span class="n">video_ids</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">id_field</span><span class="p">,</span> <span class="s1">&#39;es-related_videos&#39;</span><span class="p">,</span> <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;published_date&#39;</span> <span class="p">)</span>
    <span class="n">related_videos_query</span> <span class="o">=</span> <span class="n">related_videos_search</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">ES_Q</span><span class="p">({</span><span class="s1">&#39;terms&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;video_id.keyword&#39;</span><span class="p">:</span> <span class="n">video_ids</span><span class="p">}}))</span>
    <span class="n">related_video_map</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <p>related_videos_to_query = 5</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">related_videos_query</span><span class="o">.</span><span class="n">aggs</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="s2">&quot;group_by_video&quot;</span><span class="p">,</span> <span class="s1">&#39;terms&#39;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s1">&#39;video_id.keyword&#39;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">related_videos_query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">aggregations</span><span class="o">.</span><span class="n">group_by_video</span><span class="o">.</span><span class="n">buckets</span><span class="p">:</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">RelatedVideos</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">video_id</span><span class="o">=</span><span class="n">hits</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">video</span><span class="p">:</span>
            <span class="n">related_video_map</span><span class="p">[</span><span class="n">hits</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">video</span>
            <span class="n">related_video_map</span><span class="p">[</span><span class="n">hits</span><span class="o">.</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;related_to_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hits</span><span class="o">.</span><span class="n">doc_count</span>
    <span class="n">related_video_map</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">related_video_map</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">related_video_map</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>Return ElasticSearch request for latest daily entries given IDs and (optional) date range. Used to show latest</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">getLatestDailyRequest</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">id_field</span><span class="p">,</span> <span class="n">es_index_name</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_field</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">known</span> <span class="n">states</span> <span class="ow">or</span> <span class="n">process</span> <span class="n">aggregations</span><span class="o">.</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    sorting_params = [{&quot;extracted_date&quot;: {&quot;order&quot;: &quot;desc&quot;}}]</span>
<span class="s2">    if sort_field:</span>
<span class="s2">        sorting_params.append({sort_field: {&quot;order&quot;: &quot;desc&quot;}})</span>
<span class="s2">    daily_search = getDateRangeContentRequest(ids, fields, id_field, es_index_name, start_date, end_date)</span>
<span class="s2">    daily_search.aggs.bucket(&quot;unique_ids&quot;, &#39;terms&#39;, field=f&#39;</span><span class="si">{id_field}</span><span class="s2">.keyword&#39;)</span>
<span class="s2">    daily_search.aggs[&quot;unique_ids&quot;] </span><span class="se">\</span>
<span class="s2">        .bucket(&quot;latest_data&quot;, &#39;top_hits&#39;, sort=sorting_params, size=1)</span>
<span class="s2">    return daily_search</span>
<span class="s2">#DIVIDER</span>
<span class="s2">def getAggregatedChannelStats(channel_ids, start_date=None, end_date=None, isMaxValues=True):</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="n">Given</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">channel</span> <span class="n">IDs</span> <span class="ow">and</span> <span class="n">a</span> <span class="n">start</span><span class="o">/</span><span class="n">end</span> <span class="n">date</span><span class="p">,</span> <span class="k">return</span> <span class="n">a</span> <span class="n">dictionary</span> <span class="n">of</span> <span class="n">their</span> <span class="o">**</span><span class="n">aggregated</span><span class="o">**</span> <span class="n">statistics</span> <span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="n">videos</span> <span class="n">published</span><span class="p">,</span> <span class="ow">and</span> <span class="n">subscribers</span><span class="p">)</span><span class="o">.</span> <span class="n">ElasticSearch</span> <span class="n">fetches</span> <span class="n">the</span> <span class="n">latest</span> <span class="p">(</span><span class="nb">max</span><span class="p">)</span> <span class="n">daily</span> <span class="n">entry</span> <span class="ow">and</span> <span class="n">sums</span> <span class="n">them</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    content_eng = {&#39;total_views&#39;: 0, &#39;total_subscribers&#39;: 0, &#39;total_videos&#39;: 0}</span>
<span class="s2">    try:</span>
<span class="s2">        queried_fields = [&#39;total_views&#39;, &#39;total_videos&#39;, &#39;total_subscribers&#39;]</span>
<span class="s2">        channels_request = getLatestDailyChannelsRequest(channel_ids, queried_fields, start_date, end_date)</span>
<span class="s2">        if isMaxValues: </span>
<span class="s2">            channels_request.aggs </span><span class="se">\</span>
<span class="s2">                .metric(&#39;total_views&#39;, &#39;max&#39;, field=&#39;total_views&#39;) </span><span class="se">\</span>
<span class="s2">                .metric(&#39;total_videos&#39;, &#39;max&#39;, field=&#39;total_videos&#39;) </span><span class="se">\</span>
<span class="s2">                .metric(&#39;total_subscribers&#39;, &#39;max&#39;, field=&#39;total_subscribers&#39;)</span>
<span class="s2">        else :</span>
<span class="s2">            channels_request.aggs </span><span class="se">\</span>
<span class="s2">                .metric(&#39;total_views&#39;, &#39;sum&#39;, field=&#39;total_views&#39;) </span><span class="se">\</span>
<span class="s2">                .metric(&#39;total_videos&#39;, &#39;sum&#39;, field=&#39;total_videos&#39;) </span><span class="se">\</span>
<span class="s2">                .metric(&#39;total_subscribers&#39;, &#39;sum&#39;, field=&#39;total_subscribers&#39;)</span>
<span class="s2">        res = channels_request.execute()</span>
<span class="s2">        content_eng = {&#39;total_views&#39;: elasticSearchResponseToInteger(res.aggregations.total_views),</span>
<span class="s2">                       &#39;total_subscribers&#39;: elasticSearchResponseToInteger(res.aggregations.total_subscribers),</span>
<span class="s2">                       &#39;total_videos&#39;: elasticSearchResponseToInteger(res.aggregations.total_videos)}</span>
<span class="s2">    except Exception as e:</span>
<span class="s2">        logger.error(e)</span>
<span class="s2">    return content_eng</span>
<span class="s2">#DIVIDER</span>
<span class="s2">def getAggregatedVideoStats(video_ids, start_date=None, end_date=None):</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    content_eng = {&#39;total_views&#39;: 0, &#39;total_likes&#39;: 0, &#39;total_dislikes&#39;: 0, &#39;total_comments&#39;: 0,</span>
<span class="s2">                   &#39;video_daily_data_max&#39;: None}</span>
<span class="s2">    try:</span>
<span class="s2">        queried_fields = [&#39;total_views&#39;, &#39;total_likes&#39;, &#39;total_dislikes&#39;, &#39;total_comments&#39;]</span>
<span class="s2">        videos_request = getLatestDailyVideosRequest(video_ids, queried_fields, start_date, end_date)</span>
<span class="s2">        videos_request.aggs </span><span class="se">\</span>
<span class="s2">            .metric(&#39;total_views&#39;, &#39;max&#39;, field=&#39;total_views&#39;) </span><span class="se">\</span>
<span class="s2">            .metric(&#39;total_likes&#39;, &#39;max&#39;, field=&#39;total_likes&#39;) </span><span class="se">\</span>
<span class="s2">            .metric(&#39;total_dislikes&#39;, &#39;max&#39;, field=&#39;total_dislikes&#39;) </span><span class="se">\</span>
<span class="s2">            .metric(&#39;total_comments&#39;, &#39;max&#39;, field=&#39;total_comments&#39;)</span>
<span class="s2">        res = videos_request.execute()</span>
<span class="s2">        content_eng = {&#39;total_views&#39;: elasticSearchResponseToInteger(res.aggregations.total_views),</span>
<span class="s2">                       &#39;total_likes&#39;: elasticSearchResponseToInteger(res.aggregations.total_likes),</span>
<span class="s2">                       &#39;total_dislikes&#39;: elasticSearchResponseToInteger(res.aggregations.total_dislikes),</span>
<span class="s2">                       &#39;total_comments&#39;: elasticSearchResponseToInteger(res.aggregations.total_comments)}</span>
<span class="s2">    except Exception as e:</span>
<span class="s2">        logger.error(e)</span>
<span class="s2">    return content_eng</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      <p>Given a list of video IDs and a start/end date, return a dictionary of their <strong>aggregated</strong> statistics (views, likes, dislikes, comments). ElasticSearch fetches the latest (max) daily entry and sums them.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
